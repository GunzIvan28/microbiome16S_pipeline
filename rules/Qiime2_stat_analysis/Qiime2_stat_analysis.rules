
rule Qiime2_samples_filtration :
    conda:
        "../../envs/QIIME2-2018.8.yml"
    input:
        count_table = "{tool}/2_denoised/count-table.qza",
        Metadata_table = config["local_samples"],
    output:
        output1 = "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/filtered_samples.qza",
    params:
        filtration = '''%s="%s"''' % (config["filtration_column"], config["filtration_value"])
    log:
        logging_folder + "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/filtered_samples.txt"
    shell:
        '''
        qiime feature-table filter-samples \
            --i-table {input[count_table]} \
            --m-metadata-file {input[Metadata_table]} \
            --p-where '{config[filtration_column]}="{config[filtration_value]}"' \
            --o-filtered-table {output[output1]}
        '''

rule create_visualize_table_QIIME2_filtered :
    conda:
        "../../envs/QIIME2-2018.8.yml"
    input:
        table = "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/ANCOM/filtered_samples.qza",
        Metadata_table = config["local_samples"],
    output:
        "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/ANCOM/filtered_samples.qzv"
    log:
        logging_folder + "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/ANCOM/filtered_samples.txt"
    shell:
        '''
        qiime feature-table summarize \
            --i-table {input[table]} \
            --o-visualization {output} \
            --m-sample-metadata-file {input[Metadata_table]}
        '''


rule Qiime2_taxa_collapse :
    conda:
        "../../envs/QIIME2-2018.8.yml"
    input:
        table = "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/ANCOM/filtered_samples.qza",
        taxonomy = "{tool}/3_classified/{classifier}/{db_taxonomy}/dna-sequences_tax_assignments.qza"
    output:
         output1 = "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/ANCOM/taxa_collapse_{collapse_level}/coll_filtered_samples.qza"
    params:
        collapse_level = lambda wildcards: wildcards.collapse_level
    log:
        logging_folder + "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/ANCOM/taxa_collapse_{collapse_level}/coll_filtered_samples.txt"
    shell:
        '''
        qiime taxa collapse \
          --i-table {input[table]} \
          --i-taxonomy {input[taxonomy]} \
          --p-level {wildcards.collapse_level} \
          --o-collapsed-table {output}
        '''


rule Qiime2_pseudocounts :
    conda:
        "../../envs/QIIME2-2018.8.yml"
    input:
        "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/ANCOM/taxa_collapse_{collapse_level}/coll_filtered_samples.qza"
    output:
        "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/ANCOM/taxa_collapse_{collapse_level}/comp_filtered_samples.qza"
    log:
        logging_folder + "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/ANCOM/taxa_collapse_{collapse_level}/comp_filtered_samples.txt"
    shell:
        '''
        qiime composition add-pseudocount \
        --i-table {input} \
        --o-composition-table {output}
        '''


rule Qiime2_ANCOM :
    conda:
        "../../envs/QIIME2-2018.8.yml"
    input:
        table = "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/ANCOM/taxa_collapse_{collapse_level}/comp_filtered_samples.qza",
        Metadata = config["local_samples"],
    output:
        "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/ANCOM/taxa_collapse_{collapse_level}/ANCOM_{tested_factor}.qzv"
    params:
        tested_factor = lambda wildcards: wildcards.tested_factor
    log:
        logging_folder + "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/ANCOM/taxa_collapse_{collapse_level}/ANCOM_{tested_factor}.txt"
    shell:
        '''
        qiime composition ancom \
          --i-table {input[table]} \
          --m-metadata-file {input[Metadata]} \
          --m-metadata-column {params[tested_factor]} \
          --o-visualization {output}
        '''


rule Qiime2_Gneiss_gradient-clustering :
    conda:
        "../../envs/QIIME2-2018.8.yml"
    input:
        table = "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/filtered_samples.qza",
        Metadata = config["local_samples"],
    output:
        "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}//taxa_collapse_{collapse_level}/ANCOM_{tested_factor}.qzv"
    params:
        tested_factor = lambda wildcards: wildcards.tested_factor
    log:
        logging_folder + "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/ANCOM/taxa_collapse_{collapse_level}/ANCOM_{tested_factor}.txt"
    shell:
        '''
        qiime gneiss gradient-clustering \
          --i-table {input[table]} \
          --m-gradient-file {input[Metadata]}  \
          --m-gradient-column {params[tested_factor]} \
          --o-clustering {output}
        '''

