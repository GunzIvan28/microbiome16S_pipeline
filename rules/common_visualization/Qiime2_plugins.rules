
rule Qiime2_import_relative_freq :
    conda:
        "../../envs/QIIME2-2019.04.yml"
    input:
        "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/physeq/{collapsed_or_not}/{prefix1}/{prefix2}_trfs_export/otu_biom.biom",
    output:
        "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/physeq/{collapsed_or_not}/{prefix1}/{prefix2}_trfs_export/rel_count-table.qza"
    log:
        logging_folder + "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/physeq/{collapsed_or_not}/{prefix1}/{prefix2}_trfs_export/rel_count-table.txt"
    shell:
        '''
        qiime tools import \
          --input-path {input} \
          --type 'FeatureTable[RelativeFrequency]' \
          --input-format BIOMV100Format \
          --output-path {output}
        '''


rule Qiime2_volatility :
    conda:
        "../../envs/QIIME2-2019.04.yml"
    input:
        table = "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/physeq/{collapsed_or_not}/{prefix1}/{prefix2}_trfs_export/rel_count-table.qza",
        Metadata = config["with_type_table"],
    output:
        "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/volatility/{collapsed_or_not}/{prefix1}/{prefix2}/volatility.qzv"
    params:
        individual_id_column = config["individual_id_column"] ,
        p_state_column = config["p_state_column"]
    log:
        logging_folder + "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/Qiime2/{collapsed_or_not}/{prefix1}/{prefix2}/volatility.txt"
    shell:
        '''
        qiime longitudinal volatility \
          --i-table {input[table]} \
          --m-metadata-file {input[Metadata]} \
          --p-individual-id-column {params[individual_id_column]} \
          --p-state-column {params[p_state_column]} \
          --o-visualization {output[0]}
        '''

# https://docs.qiime2.org/2019.1/plugins/available/longitudinal/feature-volatility/
rule Qiime2_feature_volatility :
    conda:
        "../../envs/QIIME2-2019.04.yml"
    input:
        table = "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/physeq/{collapsed_or_not}/{prefix1}/{prefix2}_export/count-table.qza",
        Metadata = config["with_type_table"],
    output:
        filtered_table = "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/volatility/{collapsed_or_not}/{prefix1}/{prefix2}/feature-volatility_filtered-table.qza",
        feature_importance = "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/volatility/{collapsed_or_not}/{prefix1}/{prefix2}/feature-volatility_feature-importance.qza",
        volatility_plot = "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/volatility/{collapsed_or_not}/{prefix1}/{prefix2}/feature-volatility_volatility-plot.qzv",
        accuracy_results = "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/volatility/{collapsed_or_not}/{prefix1}/{prefix2}/feature-volatility_accuracy-results.qzv",
        sample_estimator = "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/volatility/{collapsed_or_not}/{prefix1}/{prefix2}/feature-volatility_sample-estimator.qza",
    params:
        individual_id_column = config["individual_id_column"] ,
        p_state_column = config["p_state_column"]
    log:
        logging_folder + "{tool}/5_visualization/{classifier}/{db_taxonomy}/{raref_or_not}/Qiime2/{collapsed_or_not}/{prefix1}/{prefix2}/volatility.txt"
    shell:
        '''
        qiime longitudinal feature-volatility  \
          --i-table {input[table]} \
          --m-metadata-file {input[Metadata]} \
          --p-individual-id-column {params[individual_id_column]} \
          --p-state-column {params[p_state_column]} \
          --p-cv 5 \
          --p-random-state 100 \
          --p-n-estimators 100 \
          --p-estimator RandomForestRegressor \
          --p-parameter-tuning \
          --p-missing-samples ignore \
          --o-filtered-table {output[filtered_table]} \
          --o-feature-importance {output[feature_importance]} \
          --o-volatility-plot {output[volatility_plot]} \
          --o-accuracy-results {output[accuracy_results]} \
          --o-sample-estimator {output[sample_estimator]}
        '''


