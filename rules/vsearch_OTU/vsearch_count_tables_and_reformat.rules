
rule reformat_tax_table :
    conda:
        "../../envs/QIIME1.yml"
    input:
        tax_table = "{tool}/3_classified/{classifier}/{db_taxonomy}/dna-sequences_tax_assignments.txt"
    output:
        full_taxonomy_table = "{tool}/3_classified/{classifier}/{db_taxonomy}/dna-sequences_tax_assignments_reformatted.txt"
    log:
        logging_folder + "{tool}/3_classified/{classifier}/{db_taxonomy}/dna-sequences_tax_assignments_reformatted.txt"
    script:
        "scripts/reformat_tax_table.R"


rule otus_tax_table :
    conda:
        "../../envs/r_visualization.yml"
    input:
        full_taxonomy_table = "vsearch/3_classified/{classifier}/{db_taxonomy}/dna-sequences_tax_assignments_reformatted.txt",
        count_table_samples = expand("vsearch/2_denoised/countOTUs/{sample}_count_table.txt", sample=list(read_naming.keys()))
    output:
        otus_tax_table = "{tool}/3_classified/{classifier}/{db_taxonomy}/otus_tax_table.txt"
    log:
        logging_folder +  "{tool}/3_classified/{classifier}/{db_taxonomy}/otus_tax_table.txt"
    script:
        "scripts/create_otus_tax_table.R"


rule read_counts_per_sample :
    input:
        "vsearch/1c_derep/{sample}_derep.fasta"
    output:
        "vsearch/2_denoised/reads_counts/{sample}_reads_count.txt"
    log:
        logging_folder +  "vsearch/2_denoised/reads_counts/{sample}_reads_count.txt"
    shell:
        '''
        grep ">" {input} | wc -l >> {output}
        '''


rule read_counts_merge :
    input:
        expand("vsearch/2_denoised/reads_counts/{sample}_reads_count.txt",sample=list(read_naming.keys())),
    output:
        "vsearch/2_denoised/all_samples_reads_count.txt"
    log:
        logging_folder +  "vsearch/2_denoised/all_samples_reads_count.txt"
    shell:
        '''
        cat {input} >> {output}
        '''


rule create_vsearch_count_table :
    conda:
        "../../envs/r_visualization.yml"
    input:
        count_table_samples = expand("vsearch/2_denoised/countOTUs/{sample}_count_table.txt", sample=list(read_naming.keys()))
    output:
        count_table = "vsearch/2_denoised/count_table.txt"
    log:
        logging_folder +  "vsearch/2_denoised/count_table.txt"
    script:
        "scripts/create_count_table_from_vsearch.R"

